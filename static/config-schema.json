{
  "type": "object",
  "required": ["datasets", "valueField"],
  "properties": {
    "datasets": {
      "type": "array",
      "items": [{
        "title": "Jeu de données",
        "type": "object",
        "x-fromUrl": "api/v1/datasets?status=finalized&field-type=integer,number&q={q}&select=id,title&owner={context.owner.type}:{context.owner.id}",
        "x-itemsProp": "results",
        "x-itemTitle": "title",
        "x-itemKey": "href",
        "properties": {
          "href": {"type": "string"},
          "title": {"type": "string"},
          "id": {"type": "string"}
        }
      }]
    },
    "valueField": {
      "type": "object",
      "title": "Valeur numérique",
      "description": "La colonne contenant la valeur numérique à afficher ou sur laquelle calculer une métrique.",
      "x-fromUrl": "{datasets.0.href}/schema?type=integer,number",
      "x-itemTitle": "label",
      "x-itemKey": "key"
    },
    "metricType": {
      "type": "string",
      "title": "Calcul à appliquer",
      "default": "count",
      "oneOf": [
        {"const": "count", "title": "nombre d'occurences"},
        {"const": "avg", "title": "moyenne"},
        {"const": "min", "title": "valeur minimale"},
        {"const": "max", "title": "valeur maximale"},
        {"const": "sum", "title": "somme"}
      ]
    },
    "sort": {
      "type": "string",
      "title": "Trier par",
      "default": "-metric",
      "oneOf": [
        {"const": "-metric", "title": "la valeur de la métrique (descendant)"},
        {"const": "metric", "title": "la valeur de la métrique (ascendant)"},
        {"const": "-count", "title": "le nombre de documents (descendant)"},
        {"const": "key", "title": "la clé (ascendant)"},
        {"const": "-key", "title": "la clé (descendant)"}
      ]
    },
    "size": {
      "type": "integer",
      "title": "Nombre maximal de résultats",
      "default": 10
    },
    "groupBy": {
      "type": "object",
      "title": "Grouper par",
      "default": {
        "type": "value"
      },
      "x-itemKey": "type",
      "oneOf": [{
        "title": "Valeur exacte",
        "properties": {
          "type": {
            "const": "value"
          },
          "field": {
            "type": "object",
            "title":"sur cette colonne",
            "x-fromUrl": "{datasets.0.href}/schema",
            "x-itemTitle": "label",
            "x-itemKey": "key"
          }
        }
      }, {
        "title": "Interval de date",
        "properties": {
          "type": {
            "const": "date"
          },
          "field": {
            "type": "object",
            "title":"sur cette colonne",
            "x-fromUrl": "{datasets.0.href}/schema?format=date,date-time",
            "x-itemTitle": "label",
            "x-itemKey": "key"
          },
          "interval": {
            "type": "string",
            "title": "interval",
            "default": "day",
            "oneOf": [
              {"const": "hour", "title": "Heure"},
              {"const": "day", "title": "Jour"},
              {"const": "week", "title": "Semaine"},
              {"const": "month", "title": "Mois"},
              {"const": "year", "title": "Année"}
            ]
          }
        }
      }, {
        "title": "Interval de valeur numérique",
        "properties": {
          "type": {
            "const": "number"
          },
          "field": {
            "type": "object",
            "title":"sur cette colonne",
            "x-fromUrl": "{datasets.0.href}/schema?type=integer,number",
            "x-itemTitle": "label",
            "x-itemKey": "key"
          },
          "interval": {
            "type": "integer",
            "title": "interval",
            "default": 100
          }
        }
      }]
    },
    "chart": {
      "type": "object",
      "title": "Type de visualisation",
      "default": {
        "type": "table"
      },
      "x-itemKey": "type",
      "oneOf": [{
        "title": "Table de données",
        "properties": {
          "type": {
            "const": "table"
          }
        }
      }, {
        "title": "Histogramme",
        "properties": {
          "type": {
            "const": "bar"
          },
          "colorscheme": {
            "$ref": "#/definitions/colorscheme"
          }
        }
      }, {
        "title": "Histogramme empilé",
        "required": ["secondGroupByField"],
        "properties": {
          "type": {
            "const": "stacked-bar"
          },
          "secondGroupByField": {
            "type": "object",
            "title":"Empiler par",
            "description": "La colonne sur laquelle séparer les éléments de la pile.",
            "x-fromUrl": "{datasets.0.href}/schema",
            "x-itemTitle": "label",
            "x-itemKey": "key"
          },
          "colorscheme": {
            "$ref": "#/definitions/colorscheme"
          }
        }
      }, {
        "title": "Histogramme groupé",
        "required": ["secondGroupByField"],
        "properties": {
          "type": {
            "const": "grouped-bar"
          },
          "secondGroupByField": {
            "type": "object",
            "title":"Séparer groupes par",
            "description": "La colonne sur laquelle séparer les groupes.",
            "x-fromUrl": "{datasets.0.href}/schema",
            "x-itemTitle": "label",
            "x-itemKey": "key"
          },
          "colorscheme": {
            "$ref": "#/definitions/colorscheme"
          }
        }
      }, {
        "title": "Ligne",
        "required": [],
        "properties": {
          "type": {
            "const": "line"
          },
          "colorscheme": {
            "type": "object",
            "properties": {
              "type": {
                "const": "monochrome"
              },
              "mainColor": {
                "$ref": "#/definitions/defaultColor"
              }
            }
          }
        }
      }, {
        "title": "Lignes multiples",
        "required": ["secondGroupByField"],
        "properties": {
          "type": {
            "const": "multi-lines"
          },
          "secondGroupByField": {
            "type": "object",
            "title":"Séparer par",
            "description": "La colonne sur laquelle séparer les éléments en lignes distinctes.",
            "x-fromUrl": "{datasets.0.href}/schema",
            "x-itemTitle": "label",
            "x-itemKey": "key"
          },
          "showTotal": {
            "type": "boolean",
            "title": "Montrer le total",
            "default": true
          },
          "colorscheme": {
            "$ref": "#/definitions/colorscheme"
          }
        }
      }, {
        "title": "Aire",
        "required": [],
        "properties": {
          "type": {
            "const": "area"
          },
          "colorscheme": {
            "type": "object",
            "properties": {
              "type": {
                "const": "monochrome"
              },
              "mainColor": {
                "$ref": "#/definitions/defaultColor"
              }
            }
          }
        }
      }, {
        "title": "Aires empilées",
        "required": ["secondGroupByField"],
        "properties": {
          "type": {
            "const": "stacked-area"
          },
          "secondGroupByField": {
            "type": "object",
            "title":"Empiler par",
            "description": "La colonne sur laquelle séparer les éléments de la pile.",
            "x-fromUrl": "{datasets.0.href}/schema",
            "x-itemTitle": "label",
            "x-itemKey": "key"
          },
          "colorscheme": {
            "$ref": "#/definitions/colorscheme"
          }
        }
      }, {
        "title": "Camembert",
        "properties": {
          "type": {
            "const": "pie"
          },
          "colorscheme": {
            "$ref": "#/definitions/colorscheme"
          }
        }
      }]
    },
    "staticFilters": {
      "title": "Filtres statiques",
      "type": "array",
      "items": {
        "type": "object",
        "required": ["field", "value"],
        "properties": {
          "field": {
            "type": "object",
            "title": "Colonne de filtre",
            "x-fromUrl": "{datasets.0.href}/schema",
            "x-itemTitle": "label",
            "x-itemKey": "key"
          },
          "value": {
            "type": "string",
            "title": "Valeur"
          }
        }
      }
    },
    "filters": {
      "title": "Filtres dynamiques",
      "type": "array",
      "items": {
        "type": "object",
        "required": ["field"],
        "properties": {
          "field": {
            "type": "object",
            "title": "Colonne de filtre",
            "x-fromUrl": "{datasets.0.href}/schema",
            "x-itemTitle": "label",
            "x-itemKey": "key"
          }
        }
      }
    }
  },
  "definitions": {
    "colorscheme": {
      "type": "object",
      "default": {
        "type": "monochrome"
      },
      "x-itemKey": "type",
      "oneOf": [{
        "title": "Monochrome",
        "properties": {
          "type": {
            "const": "monochrome"
          },
          "mainColor": {
            "$ref": "#/definitions/defaultColor"
          }
        }
      }, {
        "title": "Manuelle",
        "properties": {
          "type": {
            "const": "manual"
          },
          "colors": {
            "title": "Couleurs",
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "color": {
                  "$ref": "#/definitions/defaultColor"
                }
              }
            }
          }
        }
      }, {
        "title": "6 couleurs analogues",
        "properties": {
          "type": {
            "const": "analogous"
          },
          "mainColor": {
            "$ref": "#/definitions/defaultColor"
          }
        }
      }, {
        "title": "Material",
        "properties": {
          "type": {
            "const": "material"
          }
        }
      }]
    },
    "defaultColor": {
      "type": "string",
      "format": "hexcolor",
      "title": "Couleur",
      "default": "#03A9F4"
    }
  }
}
