{
  "type": "object",
  "required": ["datasets", "type"],
  "properties": {
    "datasets": {
      "type": "array",
      "items": [{
        "title": "Jeu de données",
        "description": "Ce jeu doit contenir au moins une colonne avec valeur numérique",
        "type": "object",
        "x-fromUrl": "api/v1/datasets?status=finalized&field-type=integer,number&q={q}&select=id,title&owner={context.owner.type}:{context.owner.id}",
        "x-itemsProp": "results",
        "x-itemTitle": "title",
        "x-itemKey": "href",
        "properties": {
          "href": {"type": "string"},
          "title": {"type": "string"},
          "id": {"type": "string"}
        }
      }]
    }
  },
  "dependencies": {
    "datasets.0.id": {
      "title": {
        "type": "string",
        "title": "Titre"
      },
      "oneOf": [{"$ref": "#/definitions/linesBasedChart"}, {"$ref": "#/definitions/aggBasedChart"}]
    }
  },
  "definitions": {
    "linesBasedChart": {
      "title": "valeurs simples",
      "type": "object",
      "required": ["sortBy", "sortOrder", "size", "chart", "labelsField"],
      "properties": {
        "type": {
          "title": "Préparation des données",
          "description": "Choisissez la manière de traiter les données avant de les présenter dans un graphique.\n  - **valeurs simples**: les valeurs sont lues directement depuis chaque ligne du jeu de données.\n  - **calculs**: les valeurs sont obtenues par agrégation des lignes du jeu de données et calcul (somme, moyenne, etc.)",
          "const": "linesBased"
        },
        "labelsField": {
          "type": "object",
          "title": "Libellés",
          "description": "Choisissez la colonne contenant les libellés à présenter en légende.",
          "x-fromUrl": "{datasets.0.href}/schema",
          "x-itemTitle": "label",
          "x-itemKey": "key"
        }
      },
      "dependencies": {
        "labelsField": {
          "properties": {
            "valuesFields": {
              "type": "array",
              "title": "Valeurs",
              "description": "Choisissez une ou plusieurs colonnes de valeurs numériques à présenter dans le graphique.",
              "items": {
                "type": "object",
                "required": ["field", "colorscheme"],
                "properties": {
                  "field": {"$ref": "#/definitions/valueFieldLines"},
                  "colorscheme": {"$ref": "#/definitions/fieldColorScheme"}
                }
              }
            }
          }
        },
        "valuesFields.0.field": {
          "properties": {
            "size": {"$ref": "#/definitions/size"},
            "sortBy": {"$ref": "#/definitions/sortBy"}
          }
        },
        "sortBy": {
          "properties": {
            "sortOrder": {"$ref": "#/definitions/sortOrder"},
            "chart": {"$ref": "#/definitions/chartLines"},
            "filters": {"$ref": "#/definitions/filters"}
          }
        }
      }
    },
    "aggBasedChart": {
      "title": "calculs",
      "type": "object",
      "required": ["valueField", "metricType", "groupBy", "sort", "chart"],
      "properties": {
        "type": {
          "const": "aggBased"
        },
        "valueField": {"$ref": "#/definitions/valueFieldAgg"}
      },
      "dependencies": {
        "valueField.key": {
          "properties": {
            "groupBy": {"$ref": "#/definitions/groupBy"}
          }
        },
        "groupBy.field.key": {
          "properties": {
            "metricType": {"$ref": "#/definitions/metricType"},
            "sort": {"$ref": "#/definitions/sortAgg"},
            "chart": {"$ref": "#/definitions/chartAgg"},
            "filters": {"$ref": "#/definitions/filters"}
          }
        }
      }
    },
    "valueFieldAgg": {
      "type": "object",
      "title": "Valeurs",
      "description": "La colonne contenant la valeur numérique sur laquelle effectuer un calcul.",
      "x-fromUrl": "{datasets.0.href}/schema?type=integer,number",
      "x-itemTitle": "label",
      "x-itemKey": "key"
    },
    "valueFieldLines": {
      "type": "object",
      "title": "Valeur",
      "description": "La colonne contenant une des valeurs numériques à présenter.",
      "x-fromUrl": "{datasets.0.href}/schema?type=integer,number",
      "x-itemTitle": "label",
      "x-itemKey": "key"
    },
    "sortBy": {
      "type": "object",
      "title": "Trier par",
      "x-fromUrl": "{datasets.0.href}/schema",
      "x-itemTitle": "label",
      "x-itemKey": "key"
    },
    "colorscheme": {
      "type": "object",
      "default": {
        "type": "material"
      },
      "required": ["type"],
      "oneOf": [{
        "title": "Monochrome",
        "properties": {
          "type": {
            "const": "monochrome",
            "title": "Palette de couleurs"
          },
          "mainColor": {
            "$ref": "#/definitions/defaultColor"
          }
        }
      }, {
        "title": "Manuelle",
        "properties": {
          "type": {
            "const": "manual"
          },
          "colors": {
            "title": "Couleurs",
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "color": {
                  "$ref": "#/definitions/defaultColor"
                }
              }
            }
          }
        }
      }, {
        "title": "6 couleurs analogues",
        "properties": {
          "type": {
            "const": "analogous"
          },
          "mainColor": {
            "$ref": "#/definitions/defaultColor"
          }
        }
      }, {
        "title": "Material",
        "properties": {
          "type": {
            "const": "material"
          }
        }
      }]
    },
    "fieldColorScheme": {
      "type": "object",
      "default": {
        "type": "material"
      },
      "required": ["type"],
      "oneOf": [{
        "title": "Manuelle",
        "properties": {
          "type": {
            "const": "manual",
            "title": "Palette de couleur"
          },
          "color": {
            "$ref": "#/definitions/defaultColor"
          }
        }
      }, {
        "title": "Material",
        "properties": {
          "type": {
            "const": "material"
          }
        }
      }]
    },
    "defaultColor": {
      "type": "string",
      "format": "hexcolor",
      "title": "Couleur",
      "default": "#03A9F4"
    },
    "groupBy": {
      "type": "object",
      "required": ["type"],
      "oneOf": [{
        "title": "Valeurs exactes d'une colonne",
        "required": ["field"],
        "properties": {
          "type": { "const": "value", "title": "Grouper par" },
          "field": {"$ref": "#/definitions/groupField"},
          "size": {"$ref": "#/definitions/size"}
        }
      }, {
        "title": "Intervalles d'une colonne de type date",
        "required": ["field", "interval"],
        "properties": {
          "type": { "const": "date" },
          "field": {"$ref": "#/definitions/groupFieldDate"},
          "interval": {
            "type": "string",
            "title": "Taille des intervalles",
            "default": "day",
            "oneOf": [
              {"const": "hour", "title": "Heure"},
              {"const": "day", "title": "Jour"},
              {"const": "week", "title": "Semaine"},
              {"const": "month", "title": "Mois"},
              {"const": "year", "title": "Année"}
            ]
          }
        }
      }, {
        "title": "Intervalles d'une colonne numérique",
        "required": ["field", "interval"],
        "properties": {
          "type": { "const": "number" },
          "field": {"$ref": "#/definitions/groupFieldNumber"},
          "interval": {
            "type": "integer",
            "title": "Taille des intervalles",
            "default": 100
          }
        }
      }]
    },
    "metricType": {
      "type": "string",
      "title": "Calcul à appliquer",
      "default": "sum",
      "oneOf": [
        {"const": "count", "title": "nombre d'éléments dans le groupe"},
        {"const": "avg", "title": "moyenne"},
        {"const": "min", "title": "valeur minimale"},
        {"const": "max", "title": "valeur maximale"},
        {"const": "sum", "title": "somme"}
      ]
    },
    "sortAgg": {
      "type": "string",
      "title": "Trier par",
      "default": "-metric",
      "oneOf": [
        {"const": "-metric", "title": "le résultat du calcul (descendant)"},
        {"const": "metric", "title": "le résultat du calcul (ascendant)"},
        {"const": "-count", "title": "le nombre d'éléments dans le groupe (descendant)"},
        {"const": "key", "title": "la clé du groupe (ascendant)"},
        {"const": "-key", "title": "la clé du groupe (descendant)"}
      ]
    },
    "sortOrder": {
      "type": "string",
      "title": "Ordre",
      "default": "desc",
      "oneOf": [
        {"const": "asc", "title": "Ascendant"},
        {"const": "desc", "title": "Descendant"}
      ]
    },
    "chartLines": {
      "type": "object",
      "default": {
        "type": "multi-lines"
      },
      "required": ["type"],
      "oneOf": [{
        "title": "Histogramme empilé",
        "required": ["colorscheme"],
        "properties": {
          "type": {
            "const": "stacked-bar",
            "title": "Type de visualisation"
          },
          "horizontal": {"$ref": "#/definitions/horizontal"}
        }
      }, {
        "title": "Histogramme groupé",
        "required": ["colorscheme"],
        "properties": {
          "type": {
            "const": "grouped-bar"
          },
          "horizontal": {"$ref": "#/definitions/horizontal"}
        }
      }, {
        "title": "Lignes",
        "required": ["colorscheme"],
        "properties": {
          "type": {
            "const": "multi-lines"
          }
        }
      }, {
        "title": "Aires",
        "required": ["colorscheme"],
        "properties": {
          "type": {
            "const": "stacked-area"
          }
        }
      }, {
        "title": "Camembert",
        "required": ["colorscheme"],
        "properties": {
          "type": {
            "const": "pie"
          }
        }
      }]
    },
    "chartAgg": {
      "type": "object",
      "default": {
        "type": "bar"
      },
      "required": ["type"],
      "oneOf": [{
        "title": "Histogramme",
        "required": ["colorscheme"],
        "properties": {
          "type": {
            "const": "bar",
            "title": "Type de visualisation"
          },
          "horizontal": {"$ref": "#/definitions/horizontal"},
          "colorscheme": {
            "$ref": "#/definitions/colorscheme"
          }
        }
      }, {
        "title": "Histogramme empilé",
        "required": ["secondGroupByField", "colorscheme"],
        "properties": {
          "type": {
            "const": "stacked-bar"
          },
          "horizontal": {"$ref": "#/definitions/horizontal"},
          "secondGroupByField": {
            "type": "object",
            "title":"Séparer les piles par les valeurs de cette colonne",
            "x-fromUrl": "{datasets.0.href}/schema",
            "x-itemTitle": "label",
            "x-itemKey": "key"
          },
          "secondSize": {
            "type": "integer",
            "title": "Nombre maximal d'éléments dans la pile",
            "default": 10
          },
          "colorscheme": {
            "$ref": "#/definitions/colorscheme"
          }
        }
      }, {
        "title": "Histogramme groupé",
        "required": ["secondGroupByField", "colorscheme"],
        "properties": {
          "type": {
            "const": "grouped-bar"
          },
          "horizontal": {"$ref": "#/definitions/horizontal"},
          "secondGroupByField": {
            "type": "object",
            "title":"Séparer les groupes par les valeurs de cette colonne",
            "x-fromUrl": "{datasets.0.href}/schema",
            "x-itemTitle": "label",
            "x-itemKey": "key"
          },
          "secondSize": {
            "type": "integer",
            "title": "Nombre maximal de groupes",
            "default": 10
          },
          "colorscheme": {
            "$ref": "#/definitions/colorscheme"
          }
        }
      }, {
        "title": "Ligne",
        "required": ["colorscheme"],
        "properties": {
          "type": {
            "const": "line"
          },
          "colorscheme": {
            "type": "object",
            "properties": {
              "type": {
                "const": "monochrome"
              },
              "mainColor": {
                "$ref": "#/definitions/defaultColor"
              }
            }
          }
        }
      }, {
        "title": "Lignes multiples",
        "required": ["secondGroupByField", "colorscheme"],
        "properties": {
          "type": {
            "const": "multi-lines"
          },
          "secondGroupByField": {
            "type": "object",
            "title":"Séparer les lignes par les valeurs de cette colonne",
            "x-fromUrl": "{datasets.0.href}/schema",
            "x-itemTitle": "label",
            "x-itemKey": "key"
          },
          "showTotal": {
            "type": "boolean",
            "title": "Montrer le total",
            "default": true
          },
          "secondSize": {
            "type": "integer",
            "title": "Nombre maximal de lignes",
            "default": 10
          },
          "colorscheme": {
            "$ref": "#/definitions/colorscheme"
          }
        }
      }, {
        "title": "Aire",
        "required": ["colorscheme"],
        "properties": {
          "type": {
            "const": "area"
          },
          "colorscheme": {
            "type": "object",
            "properties": {
              "type": {
                "const": "monochrome"
              },
              "mainColor": {
                "$ref": "#/definitions/defaultColor"
              }
            }
          }
        }
      }, {
        "title": "Aires empilées",
        "required": ["secondGroupByField", "colorscheme"],
        "properties": {
          "type": {
            "const": "stacked-area"
          },
          "secondGroupByField": {
            "type": "object",
            "title":"Séparer les aires par les valeurs de cette colonne",
            "x-fromUrl": "{datasets.0.href}/schema",
            "x-itemTitle": "label",
            "x-itemKey": "key"
          },
          "secondSize": {
            "type": "integer",
            "title": "Nombre maximal d'aires empilées",
            "default": 10
          },
          "colorscheme": {
            "$ref": "#/definitions/colorscheme"
          }
        }
      }, {
        "title": "Camembert",
        "required": ["colorscheme"],
        "properties": {
          "type": {
            "const": "pie"
          },
          "colorscheme": {
            "$ref": "#/definitions/colorscheme"
          }
        }
      }]
    },
    "filters": {
      "type": "object",
      "properties": {
        "staticFilters": {
          "title": "Filtres statiques",
          "description": "Ces filtres seront appliquées à tous les affichages de ce graphique de manière transparente pour l'utilisateur",
          "type": "array",
          "items": {
            "type": "object",
            "default": {
              "type": "in"
            },
            "required": ["type"],
            "oneOf": [{
              "title": "Restreindre à des valeurs",
              "properties": {
                "type": {
                  "const": "in",
                  "title": "Type de filtre"
                },
                "required": ["field", "values"],
                "field": {"$ref": "#/definitions/filterField"},
                "values": {
                  "type": "array",
                  "title": "Valeurs",
                  "items": {
                    "type": "string"
                  }
                }
              }
            }, {
              "title": "Restreindre à un interval de valeurs",
              "properties": {
                "type": {
                  "const": "interval"
                },
                "required": ["field", "values"],
                "field": {"$ref": "#/definitions/filterField"},
                "minValue": {
                  "type": "string",
                  "title": "Valeur min"
                },
                "maxValue": {
                  "type": "string",
                  "title": "Valeur max"
                }
              }
            }, {
              "title": "Exclure des valeurs",
              "properties": {
                "type": {
                  "const": "out"
                },
                "required": ["field", "values"],
                "field": {"$ref": "#/definitions/filterField"},
                "values": {
                  "type": "array",
                  "title": "Valeurs à exclure",
                  "items": {
                    "type": "string"
                  }
                }
              }
            }]
          }
        },
        "dynamicFilters": {
          "title": "Filtres dynamiques",
          "description": "Ces filtres seront proposés à l'utilisateur sous forme de formulaire en haut du graphique",
          "type": "array",
          "items": {
            "type": "object",
            "required": ["field"],
            "properties": {
              "field": {
                "type": "object",
                "title": "Colonne de filtre",
                "x-fromUrl": "{datasets.0.href}/schema",
                "x-itemTitle": "label",
                "x-itemKey": "key"
              },
              "defaultValues": {
                "type": "array",
                "title": "Valeurs par défaut",
                "items": {
                  "type": "string"
                }
              }
            }
          }
        }
      }
    },
    "size": {
      "type": "integer",
      "title": "Nombre maximal d'éléments",
      "default": 10
    },
    "groupField":  {
      "type": "object",
      "title":"Grouper en fonction de cette colonne",
      "x-fromUrl": "{datasets.0.href}/schema",
      "x-itemTitle": "label",
      "x-itemKey": "key"
    },
    "groupFieldDate":  {
      "type": "object",
      "title":"Grouper en fonction de cette colonne",
      "x-fromUrl": "{datasets.0.href}/schema?format=date,date-time",
      "x-itemTitle": "label",
      "x-itemKey": "key"
    },
    "groupFieldNumber":  {
      "type": "object",
      "title":"Grouper en fonction de cette colonne",
      "x-fromUrl": "{datasets.0.href}/schema?type=integer,number",
      "x-itemTitle": "label",
      "x-itemKey": "key"
    },
    "filterField": {
      "type": "object",
      "title": "Colonne de filtre",
      "x-fromUrl": "{datasets.0.href}/schema",
      "x-itemTitle": "label",
      "x-itemKey": "key"
    },
    "horizontal": {
      "type": "boolean",
      "title": "Inverser l'affichage"
    }
  }
}
